---
contributors:
  - Juan Nelson Martínez Dahbura
  - Shota Komatsu
  - Takanori Nishida
  - Angelo Mele
---

# README and Guidance

## Overview

This package contains the replication code for the results in the paper **"Homophily and Community Structure at Scale: An Application to a Large Professional Network"** (Dahbura, et. al. 2023). The paper presents an estimation of a Hierarchical Exponential-Family Random Graph Model (HERGM), employing the approach described in Schweinberger, et. al. (2018) using an efficient implementation of the algorithm, as described in Dahbura, et. al. (2021).

The code in this package replicates the summary statistics, plots and tables found in the manuscript. The code that processes the data and performs the estimation is written in R, and is meant to be run using [Docker](https://www.docker.com/).

Here is an brief overview of the most important components of the replication package:
- The `aea2023` package: this R package contains the functions that read and preprocess the data, obtain descriptive statistics and tables that are presented in the paper.
- The data pipelines: the results are obtained by running two pipelines implemented using the `targets` [R package](https://books.ropensci.org/targets/):
  - Data Preprocessing: it takes the raw data and forms the network object that is employed for the estimation.
  - Estimation: obtains the estimation results by employing our own implementation of the Hierarchical Exponential-family Random Graph Model (HERGM), which is publicly available on GitHub through the open source `lighthergm` [R package](https://github.com/sansan-inc/lighthergm).
- Results summaries: after running the whole pipeline, the main results are summarized in an R Markdown file for easy visualization.
- Dependency management: we attempt to facilitate reproducibility of our results and avoid dependency issues in three ways:
  - A `Dockerfile` and a `compose.yaml` file which make it easy to build the environment required by the pipeline. The Docker image that is used to reproduce the results extends the `lighthergm` image (available at the [Docker Hub](https://hub.docker.com/r/justinian336/lighthergm)), which we provide as part of the open source package.
  - An `renv` lockfile, with which we lock the versions of the packages required for replication. You can learn about `renv` in the package's [Documentation](https://rstudio.github.io/renv/articles/renv.html).
  - An RStudio environment, which can be useful for replicators to study the code and explore the results. The environment is based on the [rocker](https://hub.docker.com/r/rocker/rstudio) Docker image.

More detailed information on how to run the pipeline can be found in the sections below. The code for the `lighthergm` package, which performs the estimation according to the procedure described in the paper, is not contained in this package. If you are mainly interested in the estimation algorithm, and need to test it with your own data, you can access it through the [GitHub repository](https://github.com/sansan-inc/lighthergm). The project also provides toy data, a vignette and a Docker environment which you can use to easily get started with the `lighthergm` package.

## Data Availability and Provenance Statements

- [ ] This paper does not involve analysis of external data (i.e., no data are used or the only data are generated by the authors via simulation in their code).

The data employed for this study comes from business card exchanges performed during 2019 among users of the contact and career management app Eight, provided by Sansan, Inc., and used according to its Terms of Service.

Anonymized data can be provided strictly for the purposes of reproducing the results in this research. If you require access to the data for replication, please send an email to Sansan's Engineering Division at 33tech@sansan.com with the following information:
- Full name and affiliation of the replicator
- The name of this paper
- The names of the authors of this paper
- The explicit purpose for accessing the data

### Statement about Rights

- [x] I certify that the author(s) of the manuscript have legitimate access to and permission to use the data used in this manuscript.
- [ ] I certify that the author(s) of the manuscript have documented permission to redistribute/publish the data contained within this replication package.

### Summary of Availability

- [ ] All data **are** publicly available.
- [ ] Some data **cannot be made** publicly available.
- [x] **No data can be made** publicly available.

### Details on each Data Source
The data can only be provided through the distribution channel described in the **Data Availability and Provenance Statements** section in this document.
The pipeline employs the two `csv` files below:

- `nodes.csv`: contains information on node attributes
- `edges.csv`: contains the edgelist.

## Software requirements

The only software dependencies required to run the pipeline are `docker` and `docker compose`. The following versions were employed for estimation:
- Docker version 20.10.17, build 100c701
- Docker Compose version v2.10.2

We provide the pipeline in a Docker environment in order to make it portable across Operating Systems. Docker is available for Linux, Windows and MacOS. However, if you are a Windows user, we recommend that you run the pipeline within a Linux distribution provided through the Windows Subsystem for Linux (WSL 2) with Docker Desktop. You can find installation instructions for WSL [here](https://learn.microsoft.com/en-us/windows/wsl/install). Information on how to install Docker Desktop on WSL 2 can be found [here](https://docs.docker.com/desktop/windows/wsl/).

The R packages that are necessary for running the pipeline can be found in the `DESCRIPTION` file of the `aea2023` R package provided in this code distribution, and the specific versions employed for replications are contained in the `renv.lock` file in the same location.

### Controlled Randomness

The random seed can be set in order to reproduce the exact results in the paper. In order to set the seed, create a `.Renviron` file within the `aea2023` directory. Its content should be as follows:
```
PROJECT_SEED=16990
```
**16990** is the exact seed that was used to obtain the results in the paper. If the seed is not set this way, a random seed is chosen randomly.
You can find the actual seed that was used on a particular run by looking at the logs.


### Memory and Runtime Requirements

Running the pipeline requires at least 20GB of RAM. Although it can be run on a single CPU core, the estimation algorithm makes heavy use of parallelization to speed up algebraic operations. For this reason, runtime can vary greatly depending on the number of CPU cores available for computation.

#### Summary

Approximate time needed to reproduce the analyses on a standard (CURRENT YEAR) desktop machine:

- [ ] <10 minutes
- [ ] 10-60 minutes
- [ ] 1-2 hours
- [ ] 2-8 hours
- [x] 8-24 hours
- [ ] 1-3 days
- [ ] 3-14 days
- [ ] > 14 days
- [ ] Not feasible to run on a desktop machine, as described below.

#### Details

The code was last run on a computer with the following specifications:
- Processor: Intel(R) Xeon(R) Platinum 8259CL CPU @ 2.50GHz, 8 cores
- Memory available: 30GB
- OS: Ubuntu 20.04.2 LTS

## Description of programs/code
The code is organized as follows :

```
├── Dockerfile
├── README.md
├── .env
├── aea2023
|   ├── .Renviron
|   ├── config.yml
│   ├── DESCRIPTION
│   ├── NAMESPACE
│   ├── R
│   │   ├── network_tools.R
│   │   └── statistics_tools.R
│   ├── _targets.yaml
│   ├── aea2023.Rproj
│   ├── data
│   │   ├── edges.csv
│   │   └── nodes.csv
│   ├── man
│   ├── outputs <- directory containing the plots
│   │   ├── block_size_distribution.pdf
│   │   └── lower_bound.pdf
│   ├── renv.lock
│   ├── rmarkdown
│   │   └── replicated_result.Rmd
│   ├── run.R
│   ├── run.sh
│   ├── scripts
│   │   ├── estimation.R
│   │   └── process_data.R
│   ├── store
│   └── tests
└── compose.yaml
```

The following files are not included in this distribution of the code and must be obtained or created by the replicator:
- `.env`
- `.Renviron`
- `edges.csv`
- `nodes.csv`

Some important files include:
- `.env`: this file should contain the environment variables that get passed to Docker. If you only need to replicate the results, the only environment variable you need is `RENV_PATHS_ROOT`. By default, this points to the location of `renv`'s cache on Linux. You can change it depending on your system (For more details, see [this vignette](https://rstudio.github.io/renv/reference/paths.html) for `renv`). If you need to start an RStudio session, you can set the following variables: `PASSWORD`, `USERID` and `GROUPID`. See the documentation of the Rocker project for more information about the environment variables that can be set.
- `aea2023/.Renviron`: The random seed must be set in this file. See the **Controlled Randomness** section for details on how to set it.
- `aea2023/run.R`: this file contains the code that installs the dependencies from the `renv.lock` file and starts the pipeline.
- `aea2023/scripts`: directory where the order of execution of the different parts of the pipeline is defined.

## License for Code
The code is licensed under a GPL license. See [LICENSE.md](LICENSE.md) for details.

## Instructions to Replicators

Here we provide the instructions for reproducing the results. It assumes the following:
- The present code has been downloaded to the target computer.
- The replicator has obtained access to the data through the channel mentioned above.
- The two `csv` files have been copied to the `data` directory.
- Docker and docker compose have been installed.

These are the steps for replicating the results. All these steps should be performed from a Command Line Interface (bash, PowerShell, etc.) from this project's root directory:
1. Build the Docker image: run `docker compose build`.
2. Run the pipeline: run `docker compose up replicate-results -d` to start the pipeline. The `-d` flag starts the container as a background process. If you need to see the logs in real time, you can run `docker compose logs --follow`. Closing the logs will not kill the Docker container.
3. When the pipeline is done running, you can check the results in the `rmarkdown` directory.

It is also possible to start an RStudio instance by running `docker compose up rstudio`. You can access the UI through your browser by pointing it to `localhost:8787`.

### Running the pipeline with dummy data

In case you do not have access to the original data used in this study, it is still possible to execute the replication code using pre-created dummy data. To accomplish this, set the `R_CONFIG_ACTIVE` environment variable to "dummy". You can do so by adding the following line to your `.Renviron` file:

```
R_CONFIG_ACTIVE=dummy
```

After that, running `docker-compose up reproduce-results` will initiate the model estimation process using the dummy data. Note that the pipeline is configured to estimate the model using the original data if the `R_CONFIG_ACTIVE` environment variable is not set in the .Renv file.

We employ the `{config}` package to handle which data to use and how the pipeline runs, depending on whether the original or dummy data is being used. For more details, see the `{config}`'s vignette and `aea2023/config.yml`.

### Constructing the results summary

The package provides an `Rmd` file which can be used for creating a summary of the results in a readable format. The steps for producing the summary are the following:

1. Run the whole pipeline

2. Use `docker compose up rstudio` to start a container with RStudio.

3. Access RStudio by pointing your browser to `localhost:8787`

4. Open the `aea2023` project

5. Install the dependencies by running the following commands in the R console:

```R
renv::restore(prompt = FALSE)
devtools::install(upgrade = FALSE, dependencies = FALSE)
```

6. Open the `aea2023/rmarkdown/replicated_result.Rmd` and use `Knittr` to render it.


## References
- Martínez Dahbura, Juan Nelson, Shota Komatsu, Takanori Nishida, and Angelo Mele (2021), "A Structural Model of Business Card Exchange Networks", Working Paper, Available at https://arxiv.org/abs/2105.12704.
- Schweinberger, Michael and Pamela Luna (2018), "HERGM: Hierarchical Exponential-Family Random Graph Models", Journal of Statistical Software 85(1), 1-39.
- Introduction to renv. Available at: https://rstudio.github.io/renv/articles/renv.html
- The {targets} R package user manual. Available at: https://books.ropensci.org/targets/
